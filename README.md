[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Этот проект распространяется под лицензией MIT.  
Вы можете свободно использовать, модифицировать и распространять скрипт,  
при условии сохранения уведомления об авторских правах и текста лицензии.

# delete_old_accounts.sh - README

**Важно:** Этот скрипт **не является самостоятельным** и работает в связке с другим скриптом (например, `[check_ldap.sh](https://github.com/DonBellozi/zimbra_check_ldap)` или аналогичным), который предварительно формирует файл `/opt/zimbra/accounts_with_date.csv`.  
Без актуального CSV-файла скрипт завершится с ошибкой.

## Описание скрипта

Этот скрипт предназначен для автоматизированной очистки старых почтовых ящиков в системе Zimbra.  
Он анализирует список аккаунтов из CSV-файла, проверяет условия (давность создания или последнего входа, статус, исключения) и, если аккаунт соответствует критериям удаления (старше 1 года), создаёт резервную копию в формате `.tgz`, а затем удаляет аккаунт (или только логирует действие в режиме `--dry-run`).

### Что делает скрипт (шаг за шагом)

## Зависимые файлы

Скрипт работает с фиксированным набором файлов. Все пути заданы в переменных в начале скрипта и могут быть изменены при необходимости.

| Файл (путь)                                      | Тип     | Обязательный? | Назначение                                                                                           |
|--------------------------------------------------|---------|---------------|------------------------------------------------------------------------------------------------------|
| `/opt/zimbra/accounts_with_date.csv`             | CSV     | Да            | Основной источник данных — список всех аккаунтов с датами создания, статусом, последним входом и т.д. |
| `/opt/zimbra/logs/tmp/actual_email TXT.txt`      | TXT     | Нет           | Список исключений — email-адреса, которые **никогда** не должны удаляться.                           |
| `/opt/tmp/`                                      | Директория | Да         | Место хранения резервных копий (`<email>-YYYYMMDD.tgz`). Создаётся автоматически при необходимости. |
| `/opt/zimbra/logs/delete_old_accounts.log`       | Лог     | Авто          | Основной лог работы скрипта (обычный режим).                                                         |
| `/opt/zimbra/logs/delete_old_accounts_dryrun.log`| Лог     | Авто          | Лог работы в режиме `--dry-run`.                                                                     |
| `/opt/zimbra/logs/deleted_accounts_report.log`   | Отчёт   | Авто          | Список фактически удалённых аккаунтов в формате `email;DD.MM.YYYY`. Накапливается.                   |

1. **Чтение входных данных**
   - Загружает список аккаунтов из CSV-файла `/opt/zimbra/accounts_with_date.csv`.
   - Загружает список исключений из TXT-файла `/opt/zimbra/logs/tmp/actual_email TXT.txt` (игнорирует первую строку-заголовок, извлекает все email-адреса с помощью регулярного выражения, пустые строки игнорируются).

2. **Проверка условий для каждого аккаунта**
   - Пропускает аккаунт, если email находится в списке исключений.
   - Пропускает, если в поле **Notes** содержится подстрока `never_disable` (регистронезависимо).
   - Если поле **Последний вход** пустое → ориентируется на дату создания.
   - Если поле **Последний вход** заполнено → обрабатывает только аккаунты со статусом `closed`.
   - Порог давности: **1 год** от текущей даты.

3. **Создание резервной копии**
   - Для подходящих аккаунтов создаёт архив в директории `/opt/tmp` с именем `<email>-YYYYMMDD.tgz`.
   - Использует команду `zmmailbox -z -m "$email" getRestURL "//?fmt=tgz"`.
   - Проверяет, что архив создан и не пустой. Если архив пустой — удаление отменяется.

4. **Удаление аккаунта**
   - Если резервная копия успешно создана:
     - В обычном режиме: удаляет аккаунт командой `zmprov da "$email"`.
     - В режиме `--dry-run`: только логирует действие, без реального удаления.
   - При успешном удалении записывает строку в отчёт.

5. **Логирование и отчёты**
   - Все действия логируются в отдельный файл (разный для обычного и dry-run режимов).
   - Удалённые аккаунты записываются в отчёт в формате `email;DD.MM.YYYY`.

## Зависимости и окружение

- **Требуемые утилиты**: Bash, `date`, `grep`, `sed`, `awk`, `cut`, `tr`, `tail`, `zmprov`, `zmmailbox` (из Zimbra).
- **PATH**: автоматически дополняется `/opt/zimbra/bin:/usr/bin:/bin:/opt/zimbra/common/bin`.
- **Локаль**: `ru_RU.UTF-8` (для корректной работы с датами).
- Запускать от пользователя с правами доступа к Zimbra (обычно `zimbra` или `root` с `su - zimbra`).

## Входные файлы

### 1. CSV-файл: `/opt/zimbra/accounts_with_date.csv`

- Разделитель: `;` (точка с запятой).
- Первая строка — заголовок (игнорируется).
- Структура строк (со второй строки):

| Поле          | Описание                                                                                  | Пример                              |
|---------------|-------------------------------------------------------------------------------------------|-------------------------------------|
| Email         | Почтовый адрес                                                                            | `user@example.com`                  |
| Дата создания | Формат `YYYYMMDDHHMMSSZ` или с миллисекундами (`.846Z`)                                   | `20161007172147Z`                   |
| Статус        | `active`, `closed` и т.д. (регистронезависимо)                                            | `closed`                            |
| Notes         | Текстовая заметка (если содержит `never_disable` — аккаунт пропускается)                  | `some notes; never_disable`         |
| Последний вход| Формат `YYYY-MM-DD hh:mm:ss` или `YYYYMMDDHHMMSSZ`, может быть пустым                     | `2024-07-30 10:54:30`               |
| DisplayName   | Имя пользователя (не используется скриптом)                                               | `User Name`                         |

**Пример строки CSV**:
user@example.com;20161007172147Z;closed;some notes;;User Name
text### 2. Файл исключений: `/opt/zimbra/logs/tmp/actual_email TXT.txt`

- Первая строка — заголовок (игнорируется).
- В остальных строках могут быть один или несколько email-адресов, разделённых любыми символами.
- Пустые строки игнорируются.
- Email извлекаются регулярным выражением и приводятся к нижнему регистру.

**Пример содержимого**:
Заголовок (игнорируется)
admin@example.com, test@example.com
another@user.com
multiple emails: user1@domain.com user2@domain.com
text## Выходные файлы

### Резервные копии
- Путь: `/opt/tmp/<email>-YYYYMMDD.tgz`
- Директория создаётся автоматически.

### Логи
- Обычный режим: `/opt/zimbra/logs/delete_old_accounts.log`
- Dry-run: `/opt/zimbra/logs/delete_old_accounts_dryrun.log`

### Отчёт об удалённых аккаунтах
- Путь: `/opt/zimbra/logs/deleted_accounts_report.log`
- Формат: `email;DD.MM.YYYY` (накапливается).

## Как запускать

```bash
# Обычный режим (реальное удаление)
./delete_old_accounts.sh

# Режим dry-run (только логирование, без удаления)
./delete_old_accounts.sh --dry-run
Рекомендации по использованию

Всегда сначала запускайте в режиме --dry-run, чтобы убедиться, что всё работает как ожидается.
Проверьте логи после тестового запуска.
При необходимости очистки старых бэкапов раскомментируйте соответствующие строки в скрипте.

Возможные проблемы и отладка

CSV не найден → скрипт завершается с ошибкой.
Ошибки парсинга дат → логируются, аккаунт пропускается.
Некорректный email → удаление отменяется.
Проблемы с командами Zimbra → выводятся в лог.
Пустой бэкап → считается, что ящик не существует, удаление отменяется.

Кастомизация
Все основные пути и параметры заданы в начале скрипта в секции переменных:

CSV_FILE
EXCLUDE_FILE
BACKUP_DIR
ONE_YEAR_AGO (порог давности)
